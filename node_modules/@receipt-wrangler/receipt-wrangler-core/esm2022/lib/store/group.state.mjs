var GroupState_1;
import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { Action, createSelector, Selector, State, } from '@ngxs/store';
import { AddGroup, RemoveGroup, SetGroups, SetSelectedDashboardId, SetSelectedGroupId, UpdateGroup, } from './group.state.actions';
import * as i0 from "@angular/core";
let GroupState = GroupState_1 = class GroupState {
    static groups(state) {
        return state.groups;
    }
    static allGroupMembers(state) {
        return state.groups.map((g) => g.groupMembers).flat();
    }
    static groupsWithoutAll(state) {
        return state.groups.filter((g) => !g.isAllGroup);
    }
    static groupsWithoutSelectedGroup(state) {
        return state.groups.filter((g) => g.id.toString() !== state.selectedGroupId);
    }
    static selectedDashboardId(state) {
        return state.selectedDashboardId;
    }
    static selectedGroupId(state) {
        return state.selectedGroupId;
    }
    static receiptListLink(state) {
        return `/receipts/group/${state.selectedGroupId}`;
    }
    // TODO: needs to be fixed
    static dashboardLink(state) {
        return `/dashboard/group/${state.selectedGroupId}`;
    }
    static settingsLinkBase(state) {
        return `/groups/${state.selectedGroupId}/settings`;
    }
    static getGroupById(groupId) {
        return createSelector([GroupState_1], (state) => {
            return state.groups.find((g) => g.id.toString() === groupId.toString());
        });
    }
    addGroup({ getState, patchState }, payload) {
        const groups = Array.from(getState().groups);
        groups.push(payload.group);
        patchState({
            groups: groups,
        });
    }
    removeGroup({ getState, patchState }, payload) {
        const state = getState();
        const group = GroupState_1.getGroupById(payload.groupId)(state);
        if (group) {
            const index = state.groups.findIndex((g) => g === group);
            if (index >= 0) {
                const newInterface = {};
                const newGroups = Array.from(state.groups).filter((g) => g.id !== group.id);
                newInterface.groups = newGroups;
                if (group.id.toString() === state.selectedGroupId.toString()) {
                    newInterface.selectedGroupId = state.groups[0].id.toString();
                }
                patchState(newInterface);
            }
        }
    }
    setGroups({ patchState }, payload) {
        patchState({
            groups: payload.groups,
        });
    }
    updateGroup({ getState, patchState }, payload) {
        const groupIndex = getState().groups.findIndex((g) => g.id?.toString() === payload?.group?.id?.toString());
        if (groupIndex > -1) {
            const newGroups = Array.from(getState().groups);
            newGroups[groupIndex] = payload.group;
            patchState({
                groups: newGroups,
            });
        }
    }
    setSelectedDashboardId({ getState, patchState }, payload) {
        patchState({
            selectedDashboardId: payload.dashboardId,
        });
    }
    setSelectedGroupId({ getState, patchState }, payload) {
        let groupId = '';
        let dashboardId = '';
        if (payload?.groupId) {
            groupId = payload.groupId;
        }
        else {
            const groups = getState().groups;
            groupId = groups[0].id.toString();
        }
        if (payload.groupId === getState().selectedGroupId) {
            dashboardId = getState().selectedDashboardId;
        }
        patchState({
            selectedGroupId: groupId,
            selectedDashboardId: dashboardId,
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.11", ngImport: i0, type: GroupState, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.11", ngImport: i0, type: GroupState }); }
};
__decorate([
    Action(AddGroup),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, AddGroup]),
    __metadata("design:returntype", void 0)
], GroupState.prototype, "addGroup", null);
__decorate([
    Action(RemoveGroup),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, RemoveGroup]),
    __metadata("design:returntype", void 0)
], GroupState.prototype, "removeGroup", null);
__decorate([
    Action(SetGroups),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, SetGroups]),
    __metadata("design:returntype", void 0)
], GroupState.prototype, "setGroups", null);
__decorate([
    Action(UpdateGroup),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, UpdateGroup]),
    __metadata("design:returntype", void 0)
], GroupState.prototype, "updateGroup", null);
__decorate([
    Action(SetSelectedDashboardId),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, SetSelectedDashboardId]),
    __metadata("design:returntype", void 0)
], GroupState.prototype, "setSelectedDashboardId", null);
__decorate([
    Action(SetSelectedGroupId),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, SetSelectedGroupId]),
    __metadata("design:returntype", void 0)
], GroupState.prototype, "setSelectedGroupId", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Array)
], GroupState, "groups", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Array)
], GroupState, "allGroupMembers", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Array)
], GroupState, "groupsWithoutAll", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Array)
], GroupState, "groupsWithoutSelectedGroup", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", String)
], GroupState, "selectedDashboardId", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", String)
], GroupState, "selectedGroupId", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", String)
], GroupState, "receiptListLink", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", String)
], GroupState, "dashboardLink", null);
__decorate([
    Selector(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", String)
], GroupState, "settingsLinkBase", null);
GroupState = GroupState_1 = __decorate([
    State({
        name: 'groups',
        defaults: {
            groups: [],
            selectedGroupId: '',
            selectedDashboardId: '',
        },
    })
], GroupState);
export { GroupState };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.11", ngImport: i0, type: GroupState, decorators: [{
            type: Injectable
        }], propDecorators: { addGroup: [], removeGroup: [], setGroups: [], updateGroup: [], setSelectedDashboardId: [], setSelectedGroupId: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXAuc3RhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9jb3JlL3NyYy9saWIvc3RvcmUvZ3JvdXAuc3RhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxNQUFNLEVBQ04sY0FBYyxFQUNkLFFBQVEsRUFDUixLQUFLLEdBRU4sTUFBTSxhQUFhLENBQUM7QUFFckIsT0FBTyxFQUNMLFFBQVEsRUFDUixXQUFXLEVBQ1gsU0FBUyxFQUNULHNCQUFzQixFQUN0QixrQkFBa0IsRUFDbEIsV0FBVyxHQUNaLE1BQU0sdUJBQXVCLENBQUM7O0FBaUIvQixJQUNhLFVBQVUsa0JBRHZCLE1BQ2EsVUFBVTtJQUVkLEFBQVAsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUEwQjtRQUN0QyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDdEIsQ0FBQztJQUdNLEFBQVAsTUFBTSxDQUFDLGVBQWUsQ0FBQyxLQUEwQjtRQUMvQyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDeEQsQ0FBQztJQUdNLEFBQVAsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEtBQTBCO1FBQ2hELE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFHTSxBQUFQLE1BQU0sQ0FBQywwQkFBMEIsQ0FBQyxLQUEwQjtRQUMxRCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUN4QixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVB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WUFDUixNQUFNLEVBQUUsRUFBRTtZQUNWLGVBQWUsRUFBRSxFQUFFO1lBQ25CLG1CQUFtQixFQUFFLEVBQUU7U0FDeEI7S0FDRixDQUFDO0dBRVcsVUFBVSxDQXlKdEI7U0F6SlksVUFBVTs0RkFBVixVQUFVO2tCQUR0QixVQUFVOzhCQXlEVCxRQUFRLE1BYVIsV0FBVyxNQXVCWCxTQUFTLE1BVVQsV0FBVyxNQWtCWCxzQkFBc0IsTUFVdEIsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQWN0aW9uLFxuICBjcmVhdGVTZWxlY3RvcixcbiAgU2VsZWN0b3IsXG4gIFN0YXRlLFxuICBTdGF0ZUNvbnRleHQsXG59IGZyb20gJ0BuZ3hzL3N0b3JlJztcbmltcG9ydCB7IEdyb3VwIH0gZnJvbSAnLi4vYXBpL21vZGVsL2dyb3VwJztcbmltcG9ydCB7XG4gIEFkZEdyb3VwLFxuICBSZW1vdmVHcm91cCxcbiAgU2V0R3JvdXBzLFxuICBTZXRTZWxlY3RlZERhc2hib2FyZElkLFxuICBTZXRTZWxlY3RlZEdyb3VwSWQsXG4gIFVwZGF0ZUdyb3VwLFxufSBmcm9tICcuL2dyb3VwLnN0YXRlLmFjdGlvbnMnO1xuaW1wb3J0IHsgR3JvdXBNZW1iZXIgfSBmcm9tICcuLi9hcGkvbW9kZWwvZ3JvdXBNZW1iZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIEdyb3VwU3RhdGVJbnRlcmZhY2Uge1xuICBncm91cHM6IEdyb3VwW107XG4gIHNlbGVjdGVkR3JvdXBJZDogc3RyaW5nO1xuICBzZWxlY3RlZERhc2hib2FyZElkOiBzdHJpbmc7XG59XG5cbkBTdGF0ZTxHcm91cFN0YXRlSW50ZXJmYWNlPih7XG4gIG5hbWU6ICdncm91cHMnLFxuICBkZWZhdWx0czoge1xuICAgIGdyb3VwczogW10sXG4gICAgc2VsZWN0ZWRHcm91cElkOiAnJyxcbiAgICBzZWxlY3RlZERhc2hib2FyZElkOiAnJyxcbiAgfSxcbn0pXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgR3JvdXBTdGF0ZSB7XG4gIEBTZWxlY3RvcigpXG4gIHN0YXRpYyBncm91cHMoc3RhdGU6IEdyb3VwU3RhdGVJbnRlcmZhY2UpOiBHcm91cFtdIHtcbiAgICByZXR1cm4gc3RhdGUuZ3JvdXBzO1xuICB9XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIGFsbEdyb3VwTWVtYmVycyhzdGF0ZTogR3JvdXBTdGF0ZUludGVyZmFjZSk6IEdyb3VwTWVtYmVyW10ge1xuICAgIHJldHVybiBzdGF0ZS5ncm91cHMubWFwKChnKSA9PiBnLmdyb3VwTWVtYmVycykuZmxhdCgpO1xuICB9XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIGdyb3Vwc1dpdGhvdXRBbGwoc3RhdGU6IEdyb3VwU3RhdGVJbnRlcmZhY2UpOiBHcm91cFtdIHtcbiAgICByZXR1cm4gc3RhdGUuZ3JvdXBzLmZpbHRlcigoZykgPT4gIWcuaXNBbGxHcm91cCk7XG4gIH1cblxuICBAU2VsZWN0b3IoKVxuICBzdGF0aWMgZ3JvdXBzV2l0aG91dFNlbGVjdGVkR3JvdXAoc3RhdGU6IEdyb3VwU3RhdGVJbnRlcmZhY2UpOiBHcm91cFtdIHtcbiAgICByZXR1cm4gc3RhdGUuZ3JvdXBzLmZpbHRlcihcbiAgICAgIChnKSA9PiBnLmlkLnRvU3RyaW5nKCkgIT09IHN0YXRlLnNlbGVjdGVkR3JvdXBJZFxuICAgICk7XG4gIH1cblxuICBAU2VsZWN0b3IoKVxuICBzdGF0aWMgc2VsZWN0ZWREYXNoYm9hcmRJZChzdGF0ZTogR3JvdXBTdGF0ZUludGVyZmFjZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHN0YXRlLnNlbGVjdGVkRGFzaGJvYXJkSWQ7XG4gIH1cblxuICBAU2VsZWN0b3IoKVxuICBzdGF0aWMgc2VsZWN0ZWRHcm91cElkKHN0YXRlOiBHcm91cFN0YXRlSW50ZXJmYWNlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc3RhdGUuc2VsZWN0ZWRHcm91cElkO1xuICB9XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIHJlY2VpcHRMaXN0TGluayhzdGF0ZTogR3JvdXBTdGF0ZUludGVyZmFjZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAvcmVjZWlwdHMvZ3JvdXAvJHtzdGF0ZS5zZWxlY3RlZEdyb3VwSWR9YDtcbiAgfVxuXG4gIC8vIFRPRE86IG5lZWRzIHRvIGJlIGZpeGVkXG4gIEBTZWxlY3RvcigpXG4gIHN0YXRpYyBkYXNoYm9hcmRMaW5rKHN0YXRlOiBHcm91cFN0YXRlSW50ZXJmYWNlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYC9kYXNoYm9hcmQvZ3JvdXAvJHtzdGF0ZS5zZWxlY3RlZEdyb3VwSWR9YDtcbiAgfVxuXG4gIEBTZWxlY3RvcigpXG4gIHN0YXRpYyBzZXR0aW5nc0xpbmtCYXNlKHN0YXRlOiBHcm91cFN0YXRlSW50ZXJmYWNlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYC9ncm91cHMvJHtzdGF0ZS5zZWxlY3RlZEdyb3VwSWR9L3NldHRpbmdzYDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRHcm91cEJ5SWQoZ3JvdXBJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGNyZWF0ZVNlbGVjdG9yKFtHcm91cFN0YXRlXSwgKHN0YXRlOiBHcm91cFN0YXRlSW50ZXJmYWNlKSA9PiB7XG4gICAgICByZXR1cm4gc3RhdGUuZ3JvdXBzLmZpbmQoKGcpID0+IGcuaWQudG9TdHJpbmcoKSA9PT0gZ3JvdXBJZC50b1N0cmluZygpKTtcbiAgICB9KTtcbiAgfVxuXG4gIEBBY3Rpb24oQWRkR3JvdXApXG4gIGFkZEdyb3VwKFxuICAgIHsgZ2V0U3RhdGUsIHBhdGNoU3RhdGUgfTogU3RhdGVDb250ZXh0PEdyb3VwU3RhdGVJbnRlcmZhY2U+LFxuICAgIHBheWxvYWQ6IEFkZEdyb3VwXG4gICkge1xuICAgIGNvbnN0IGdyb3VwcyA9IEFycmF5LmZyb20oZ2V0U3RhdGUoKS5ncm91cHMpO1xuICAgIGdyb3Vwcy5wdXNoKHBheWxvYWQuZ3JvdXApO1xuXG4gICAgcGF0Y2hTdGF0ZSh7XG4gICAgICBncm91cHM6IGdyb3VwcyxcbiAgICB9KTtcbiAgfVxuXG4gIEBBY3Rpb24oUmVtb3ZlR3JvdXApXG4gIHJlbW92ZUdyb3VwKFxuICAgIHsgZ2V0U3RhdGUsIHBhdGNoU3RhdGUgfTogU3RhdGVDb250ZXh0PEdyb3VwU3RhdGVJbnRlcmZhY2U+LFxuICAgIHBheWxvYWQ6IFJlbW92ZUdyb3VwXG4gICkge1xuICAgIGNvbnN0IHN0YXRlID0gZ2V0U3RhdGUoKTtcbiAgICBjb25zdCBncm91cCA9IEdyb3VwU3RhdGUuZ2V0R3JvdXBCeUlkKHBheWxvYWQuZ3JvdXBJZCkoc3RhdGUpO1xuICAgIGlmIChncm91cCkge1xuICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5ncm91cHMuZmluZEluZGV4KChnKSA9PiBnID09PSBncm91cCk7XG4gICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICBjb25zdCBuZXdJbnRlcmZhY2UgPSB7fSBhcyBHcm91cFN0YXRlSW50ZXJmYWNlO1xuICAgICAgICBjb25zdCBuZXdHcm91cHMgPSBBcnJheS5mcm9tKHN0YXRlLmdyb3VwcykuZmlsdGVyKFxuICAgICAgICAgIChnKSA9PiBnLmlkICE9PSBncm91cC5pZFxuICAgICAgICApO1xuICAgICAgICBuZXdJbnRlcmZhY2UuZ3JvdXBzID0gbmV3R3JvdXBzO1xuICAgICAgICBpZiAoZ3JvdXAuaWQudG9TdHJpbmcoKSA9PT0gc3RhdGUuc2VsZWN0ZWRHcm91cElkLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICBuZXdJbnRlcmZhY2Uuc2VsZWN0ZWRHcm91cElkID0gc3RhdGUuZ3JvdXBzWzBdLmlkLnRvU3RyaW5nKCk7XG4gICAgICAgIH1cbiAgICAgICAgcGF0Y2hTdGF0ZShuZXdJbnRlcmZhY2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIEBBY3Rpb24oU2V0R3JvdXBzKVxuICBzZXRHcm91cHMoXG4gICAgeyBwYXRjaFN0YXRlIH06IFN0YXRlQ29udGV4dDxHcm91cFN0YXRlSW50ZXJmYWNlPixcbiAgICBwYXlsb2FkOiBTZXRHcm91cHNcbiAgKSB7XG4gICAgcGF0Y2hTdGF0ZSh7XG4gICAgICBncm91cHM6IHBheWxvYWQuZ3JvdXBzLFxuICAgIH0pO1xuICB9XG5cbiAgQEFjdGlvbihVcGRhdGVHcm91cClcbiAgdXBkYXRlR3JvdXAoXG4gICAgeyBnZXRTdGF0ZSwgcGF0Y2hTdGF0ZSB9OiBTdGF0ZUNvbnRleHQ8R3JvdXBTdGF0ZUludGVyZmFjZT4sXG4gICAgcGF5bG9hZDogVXBkYXRlR3JvdXBcbiAgKSB7XG4gICAgY29uc3QgZ3JvdXBJbmRleCA9IGdldFN0YXRlKCkuZ3JvdXBzLmZpbmRJbmRleChcbiAgICAgIChnKSA9PiBnLmlkPy50b1N0cmluZygpID09PSBwYXlsb2FkPy5ncm91cD8uaWQ/LnRvU3RyaW5nKClcbiAgICApO1xuICAgIGlmIChncm91cEluZGV4ID4gLTEpIHtcbiAgICAgIGNvbnN0IG5ld0dyb3VwcyA9IEFycmF5LmZyb20oZ2V0U3RhdGUoKS5ncm91cHMpO1xuICAgICAgbmV3R3JvdXBzW2dyb3VwSW5kZXhdID0gcGF5bG9hZC5ncm91cDtcblxuICAgICAgcGF0Y2hTdGF0ZSh7XG4gICAgICAgIGdyb3VwczogbmV3R3JvdXBzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgQEFjdGlvbihTZXRTZWxlY3RlZERhc2hib2FyZElkKVxuICBzZXRTZWxlY3RlZERhc2hib2FyZElkKFxuICAgIHsgZ2V0U3RhdGUsIHBhdGNoU3RhdGUgfTogU3RhdGVDb250ZXh0PEdyb3VwU3RhdGVJbnRlcmZhY2U+LFxuICAgIHBheWxvYWQ6IFNldFNlbGVjdGVkRGFzaGJvYXJkSWRcbiAgKSB7XG4gICAgcGF0Y2hTdGF0ZSh7XG4gICAgICBzZWxlY3RlZERhc2hib2FyZElkOiBwYXlsb2FkLmRhc2hib2FyZElkLFxuICAgIH0pO1xuICB9XG5cbiAgQEFjdGlvbihTZXRTZWxlY3RlZEdyb3VwSWQpXG4gIHNldFNlbGVjdGVkR3JvdXBJZChcbiAgICB7IGdldFN0YXRlLCBwYXRjaFN0YXRlIH06IFN0YXRlQ29udGV4dDxHcm91cFN0YXRlSW50ZXJmYWNlPixcbiAgICBwYXlsb2FkOiBTZXRTZWxlY3RlZEdyb3VwSWRcbiAgKSB7XG4gICAgbGV0IGdyb3VwSWQgPSAnJztcbiAgICBsZXQgZGFzaGJvYXJkSWQgPSAnJztcblxuICAgIGlmIChwYXlsb2FkPy5ncm91cElkKSB7XG4gICAgICBncm91cElkID0gcGF5bG9hZC5ncm91cElkO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBncm91cHMgPSBnZXRTdGF0ZSgpLmdyb3VwcztcbiAgICAgIGdyb3VwSWQgPSBncm91cHNbMF0uaWQudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBpZiAocGF5bG9hZC5ncm91cElkID09PSBnZXRTdGF0ZSgpLnNlbGVjdGVkR3JvdXBJZCkge1xuICAgICAgZGFzaGJvYXJkSWQgPSBnZXRTdGF0ZSgpLnNlbGVjdGVkRGFzaGJvYXJkSWQ7XG4gICAgfVxuXG4gICAgcGF0Y2hTdGF0ZSh7XG4gICAgICBzZWxlY3RlZEdyb3VwSWQ6IGdyb3VwSWQsXG4gICAgICBzZWxlY3RlZERhc2hib2FyZElkOiBkYXNoYm9hcmRJZCxcbiAgICB9KTtcbiAgfVxufVxuIl19